#!/bin/sh

REMOTE_SHA=$(git ls-remote origin main | cut -f1)
LOCAL_SHA=$(git rev-parse main)

# Check if remote branch exists
if [ -z "$REMOTE_SHA" ]; then
  echo "Error: Remote branch 'main' not found. Cannot push."
  exit 1
fi

CHANGED_FILES=$(git diff --name-only "$REMOTE_SHA" "$LOCAL_SHA")

run_client_tests=false
run_web_app_tests=false
run_recommender_tests=false

echo "$CHANGED_FILES" | grep -q '^client/' && run_client_tests=true
echo "$CHANGED_FILES" | grep -q '^server/web-app/' && run_web_app_tests=true
echo "$CHANGED_FILES" | grep -q '^server/recommender-api/' && run_recommender_tests=true

if [ "$run_client_tests" = true ]; then
  echo "No React tests yet..."
fi

if [ "$run_web_app_tests" = true ]; then
  echo "Running NestJS web-app pre-push checks..."
  cd server/web-app || exit 1

  echo "Installing dependencies..."
  start_time=$(date +%s)

  npm ci --silent
  npx prisma generate --no-hints > /dev/null

  end_time=$(date +%s)
  duration=$((end_time - start_time))
  echo "Dependencies installed in $duration seconds."

  echo "Running NestJS web-app tests..."
  npm test || exit 1

  cd - >/dev/null
fi

if [ "$run_recommender_tests" = true ]; then
  echo "No recommender-api Python tests yet..."
fi

if [ "$run_client_tests" = false ] && [ "$run_web_app_tests" = false ] && [ "$run_recommender_tests" = false ]; then
  echo "No relevant changes — skipping tests."
fi

echo "✅ Pre-push checks passed."
